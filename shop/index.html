<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Учёт проданных футболок</title>
<style>
body { font-family: sans-serif; background: #f9fafb; margin: 0; padding: 20px; }
h1 { margin-bottom: 10px; }
.product { border: 1px solid #ddd; background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; gap: 15px; cursor: move; }
.product.dragging { opacity: 0.5; }
.photo { width: 120px; height: 120px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor:pointer; }
.photo img { width: 100%; height: 100%; object-fit: cover; }
.sizes { display: flex; gap: 10px; margin-top: 10px; }
.size { display: flex; flex-direction: column; align-items: center; border: 1px solid #ddd; border-radius: 8px; padding: 8px; width: 60px; }
button { cursor: pointer; margin: 2px; padding: 5px 10px; border-radius: 6px; border: 1px solid #ccc; background: #f8f8f8; }
button:hover { background: #eee; }
.controls { margin-top: 10px; }
footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 14px; }
#previewModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:1000; }
#previewModal img { max-width:90%; max-height:90%; border-radius:10px; }
#previewModal span { position:absolute; top:20px; right:30px; font-size:30px; color:#fff; cursor:pointer; }
</style>
</head>
<body>

<h1>Учёт проданных футболок</h1>
<button onclick="addProduct()">Добавить товар</button>
<button onclick="resetAll()">Сбросить остатки</button>
<button onclick="exportCSV()">Экспорт CSV</button>
<input type="file" accept=".csv" onchange="importCSV(this.files[0])">

<div id="products"></div>
<footer>
  <div id="totals"></div>
</footer>

<div id="previewModal">
  <span onclick="closePreview()">&times;</span>
  <img src="" alt="Preview">
</div>

<script>
let products = JSON.parse(localStorage.getItem("tshirt_inventory_v1") || "[]");
let dragSrcIndex = null;

const save = () => { localStorage.setItem("tshirt_inventory_v1", JSON.stringify(products)); render(); };
const addProduct = () => { products.unshift({ id: Date.now(), name: "Новый товар", image: "", sizes: {S:0,M:0,L:0} }); save(); };
const removeProduct = id => { products = products.filter(p => p.id !== id); save(); };
const updateSize = (id,size,delta) => { const p=products.find(p=>p.id===id); if(!p) return; p.sizes[size]=Math.max(0,(p.sizes[size]||0)+delta); save(); };
const updateName = (id,value) => { products.find(p=>p.id===id).name=value; save(); };
const updateImage = (id,value) => { products.find(p=>p.id===id).image=value; save(); };
const uploadImage = (id,file) => { const reader=new FileReader(); reader.onload=e=>updateImage(id,e.target.result); reader.readAsDataURL(file); };
const resetAll = () => { if(!confirm("Сбросить остатки всех товаров?")) return; products.forEach(p=>p.sizes={S:0,M:0,L:0}); save(); };

// Откроем превью
const openPreview = src => {
  if (!src) return;
  const modal = document.getElementById("previewModal");
  modal.querySelector("img").src = src;
  modal.style.display = "flex";
};

// Закроем превью по клику вне картинки
const closePreview = () => {
  document.getElementById("previewModal").style.display = "none";
};

// Добавляем событие на модальное окно
document.getElementById("previewModal").addEventListener("click", (e) => {
  if (e.target.id === "previewModal") closePreview(); // клик только по фону
});


const exportCSV = () => {
  const header = "Название,Изображение,S,M,L,Итого";
  const rows = products.map(p=>[p.name,p.image,p.sizes.S,p.sizes.M,p.sizes.L,p.sizes.S+p.sizes.M+p.sizes.L].join(","));
  const totals = calcTotals();
  const footer = ["ИТОГО","",totals.S,totals.M,totals.L,totals.all].join(",");
  const csv = [header,...rows,footer].join("\n");
  const blob = new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="inventory.csv"; a.click(); URL.revokeObjectURL(url);
};

const importCSV = file => {
  const reader=new FileReader();
  reader.onload=e=>{
    const lines = e.target.result.split("\n").slice(1).filter(Boolean);
    lines.forEach(line=>{
      const [name,image,S,M,L] = line.split(",");
      if(name && image!==undefined){
        products.push({ id:Date.now()+Math.random(), name:name.trim(), image:image.trim(), sizes:{S:+S,M:+M,L:+L} });
      }
    });
    save();
  };
  reader.readAsText(file);
};

const calcTotals = () => products.reduce((sum,p)=>({S:sum.S+p.sizes.S,M:sum.M+p.sizes.M,L:sum.L+p.sizes.L,all:sum.all+p.sizes.S+p.sizes.M+p.sizes.L}),{S:0,M:0,L:0,all:0});

function handleDragStart(e,index){ dragSrcIndex=index; e.currentTarget.classList.add('dragging'); }
function handleDragEnd(e){ e.currentTarget.classList.remove('dragging'); }
function handleDragOver(e){ e.preventDefault(); }
function handleDrop(e,index){ if(dragSrcIndex===null || dragSrcIndex===index) return; const tmp=products[dragSrcIndex]; products.splice(dragSrcIndex,1); products.splice(index,0,tmp); dragSrcIndex=null; save(); }

const render = () => {
  const container = document.getElementById("products");
  container.innerHTML = "";
  products.forEach((p,index)=>{
    const total=p.sizes.S+p.sizes.M+p.sizes.L;
    const div=document.createElement("div");
    div.className="product";
    div.draggable=true;
    div.innerHTML=`
      <div class="photo">${p.image ? `<img src="${p.image}" alt="Preview">` : "Фото"}</div>
      <div style="flex:1">
        <input type="text" value="${p.name}" onchange="updateName(${p.id}, this.value)" placeholder="Название" style="width:100%;padding:4px;">
        <input type="text" value="${p.image.startsWith('data:') ? '' : p.image}" onchange="updateImage(${p.id}, this.value); render();" placeholder="URL изображения" style="width:100%;margin-top:4px;padding:4px;">
        <input type="file" accept="image/*" onchange="uploadImage(${p.id}, this.files[0])" style="width:100%;margin-top:4px;">
        <div class="sizes">
          ${["S","M","L"].map(size=>`
            <div class="size">
              <div>${size}</div>
              <button onclick="updateSize(${p.id}, '${size}', 1)">+</button>
              <div>${p.sizes[size]}</div>
              <button onclick="updateSize(${p.id}, '${size}', -1)">-</button>
            </div>`).join("")}
        </div>
        <div class="controls">
          Итого: <b>${total}</b>
          <button onclick="removeProduct(${p.id})" style="color:red;margin-left:10px;">Удалить</button>
        </div>
      </div>`;
    // Открытие превью при клике
    const photoDiv = div.querySelector(".photo");
    photoDiv.addEventListener("click",()=>openPreview(p.image));
    div.addEventListener("dragstart", e=>handleDragStart(e,index));
    div.addEventListener("dragend", handleDragEnd);
    div.addEventListener("dragover", handleDragOver);
    div.addEventListener("drop", e=>handleDrop(e,index));
    container.appendChild(div);
  });
  const totals = calcTotals();
  document.getElementById("totals").textContent=`Итого по размерам: S ${totals.S}, M ${totals.M}, L ${totals.L}. Общий остаток: ${totals.all}`;
};

render();
</script>
</body>
</html>
