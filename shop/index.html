<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Учёт проданных футболок</title>
<style>
body { font-family: sans-serif; background: #f9fafb; margin: 0; padding: 20px; }
h1 { margin-bottom: 10px; }
.product { border: 1px solid #ddd; background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; gap: 15px; cursor: move; }
.product.dragging { opacity: 0.5; }
.photo { width: 120px; height: 120px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor:pointer; }
.photo img { width: 100%; height: 100%; object-fit: cover; }
.sizes { display: flex; gap: 10px; margin-top: 10px; }
.size { display: flex; flex-direction: column; align-items: center; border: 1px solid #ddd; border-radius: 8px; padding: 8px; width: 60px; }
button { cursor: pointer; margin: 2px; padding: 5px 10px; border-radius: 6px; border: 1px solid #ccc; background: #f8f8f8; }
button:hover { background: #eee; }
.controls { margin-top: 10px; }
#products {
  margin-top: 50px; /* высота шапки + немного отступа */
    margin-bottom: 30px; /* высота футера + небольшой запас */
}
#buttons {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #f9fafb;
  padding: 10px 20px;
  border-bottom: 1px solid #ddd;
  display: flex;
  gap: 10px;
  z-index: 100;
}
.custom-file-btn {cursor: pointer; margin: 2px; padding: 5px 10px; border-radius: 6px; border: 1px solid #ccc; background: #f8f8f8;
}
.custom-file-btn:hover {
  background: #eee;
}

footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #f9fafb;
  padding: 10px 20px;
  border-top: 1px solid #ddd;
  font-size: 14px;
  z-index: 100;
}
#previewModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:1000; }
#previewModal img { max-width:90%; max-height:90%; border-radius:10px; }
</style>
</head>
<body>
<div id="buttons">
  <button id="btnAdd">Добавить товар</button>
  <button id="btnReset">Сбросить остатки</button>
  <button id="btnExport">Экспорт CSV</button>
<label id="btnImport" class="custom-file-btn">
  Выберите файл
  <input type="file" id="csvFile" accept=".csv" style="display:none;">
</label>
</div>

<div id="products"></div>
<footer>
  <div id="totals"></div>
</footer>

<div id="previewModal">
  <img src="" alt="Preview">
</div>

<script type="module">
    

// ---------- Supabase setup ----------
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const SUPABASE_URL = 'https://bzwbwkatepezdwamqvbn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6d2J3a2F0ZXBlemR3YW1xdmJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjYyNjksImV4cCI6MjA3MTcwMjI2OX0.lIhvm7XKqPfH6qEr3Hz-zT3ZlMfbmaDXsTgKnlYUeAA';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// ---------- Variables ----------
let products = [];
let dragSrcIndex = null;

// ---------- Supabase functions ----------
async function loadFromSupabase() {
  const { data, error } = await supabase.from('tshirts').select('*').order('id', { ascending: false });
  if(!error && data) {
    products = data.map(p=>({ id: p.id, name: p.name, image: p.image, sizes: p.sizes }));
    render();
  } else {
    products = JSON.parse(localStorage.getItem("tshirt_inventory_v1") || "[]");
    render();
  }
}

async function saveProductOnline(product) {
  await supabase.from('tshirts').upsert([product]);
}

async function deleteProductOnline(id) {
  await supabase.from('tshirts').delete().eq('id', id);
}

// ---------- LocalStorage backup ----------
function saveLocal() { localStorage.setItem("tshirt_inventory_v1", JSON.stringify(products)); }

// ---------- Product functions ----------
function generateId() { return Date.now() + Math.floor(Math.random()*1000); }

function addProduct() {
  const p = { id: generateId(), name: "Новый товар", image: "", sizes: {S:0,M:0,L:0} };
  products.unshift(p);
  saveProductOnline(p);
  saveLocal();
  render();
}

function updateName(id,value) {
  const p = products.find(p=>p.id===id);
  if(!p) return;
  p.name=value;
  saveProductOnline(p);
  saveLocal();
  render();
}

function updateImage(id,value) {
  const p = products.find(p=>p.id===id);
  if(!p) return;
  p.image=value;
  saveProductOnline(p);
  saveLocal();
  render();
}

function updateSize(id,size,delta) {
  const p = products.find(p=>p.id===id);
  if(!p) return;
  p.sizes[size] = Math.max(0,(p.sizes[size]||0)+delta);
  saveProductOnline(p);
  saveLocal();
  render();
}

function removeProduct(id) {
  const index = products.findIndex(p=>p.id===id);
  if(index===-1) return;
  products.splice(index,1);
  deleteProductOnline(id);
  saveLocal();
  render();
}

function resetAll() {
  if(!confirm("Сбросить остатки всех товаров?")) return;
  products.forEach(p=>{ p.sizes={S:0,M:0,L:0}; saveProductOnline(p); });
  saveLocal();
  render();
}

// ---------- Preview functions ----------
function openPreview(src) {
  if(!src) return;
  const modal = document.getElementById("previewModal");
  modal.querySelector("img").src=src;
  modal.style.display="flex";
}

function closePreview() { document.getElementById("previewModal").style.display="none"; }
document.getElementById("previewModal").addEventListener("click",e=>{
  if(e.target.id==="previewModal") closePreview();
});

function uploadImage(id,file){
  const reader=new FileReader();
  reader.onload=e=>updateImage(id,e.target.result);
  reader.readAsDataURL(file);
}

// ---------- CSV functions ----------
function exportCSV(){
  const header="Название,Изображение,S,M,L,Итого";
  const rows = products.map(p=>[p.name,p.image,p.sizes.S,p.sizes.M,p.sizes.L,p.sizes.S+p.sizes.M+p.sizes.L].join(","));
  const totals = calcTotals();
  const footer=["ИТОГО","",totals.S,totals.M,totals.L,totals.all].join(",");
  const csv=[header,...rows,footer].join("\n");
  const blob = new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="inventory.csv"; a.click(); URL.revokeObjectURL(url);
}

function importCSV(file){
  const reader = new FileReader();
  reader.onload = async e => {
    const text = e.target.result;
    const lines = text.split("\n").slice(1).filter(Boolean);
    for (const line of lines) {
      const match = line.match(/(?:\"([^\"]*)\")|([^,]+)/g);
      if(!match) continue;
      const [name,image,S,M,L] = match.map(s => s.replace(/^"|"$/g,"").trim());
      if(name && image!==undefined){
        const p = { id: generateId(), name, image, sizes: {S:+S,M:+M,L:+L} };
        products.push(p);
        await saveProductOnline(p);
      }
    }
    saveLocal();
    render();
  };
  reader.readAsText(file);
}

// ---------- Drag & Drop ----------
function handleDragStart(e,index){ dragSrcIndex=index; e.currentTarget.classList.add('dragging'); }
function handleDragEnd(e){ e.currentTarget.classList.remove('dragging'); }
function handleDragOver(e){ e.preventDefault(); }
function handleDrop(e,index){ 
  if(dragSrcIndex===null || dragSrcIndex===index) return; 
  const tmp=products[dragSrcIndex]; 
  products.splice(dragSrcIndex,1); 
  products.splice(index,0,tmp); 
  dragSrcIndex=null; 
  saveLocal();
  render();
}

// ---------- Render ----------
function calcTotals(){
  return products.reduce((sum,p)=>({S:sum.S+p.sizes.S,M:sum.M+p.sizes.M,L:sum.L+p.sizes.L,all:sum.all+p.sizes.S+p.sizes.M+p.sizes.L}),{S:0,M:0,L:0,all:0});
}

function render(){
  const container=document.getElementById("products");
  container.innerHTML="";
  products.forEach((p,index)=>{
    const total=p.sizes.S+p.sizes.M+p.sizes.L;
    const div=document.createElement("div");
    div.className="product";
    div.draggable=true;

    div.innerHTML=`
      <div class="photo">${p.image ? `<img src="${p.image}" alt="Preview">` : "Фото"}</div>
      <div style="flex:1">
        <input type="text" value="${p.name}" placeholder="Название" style="width:100%;padding:4px;">
        <input type="text" value="${p.image.startsWith('data:')?'':p.image}" placeholder="URL изображения" style="width:100%;margin-top:4px;padding:4px;display:none;" >
        <div class="sizes">
          ${["S","M","L"].map(size=>`
            <div class="size">
              <div>${size}</div>
              <button class="plus" data-id="${p.id}" data-size="${size}">+</button>
              <div class="count">${p.sizes[size]}</div>
              <button class="minus" data-id="${p.id}" data-size="${size}">-</button>
            </div>`).join("")}
        </div>
        <div class="controls">
          Итого: <b>${total}</b>
          <button class="remove" data-id="${p.id}" style="color:red;margin-left:10px;">Удалить</button>
        </div>
      </div>`;

    // preview
    div.querySelector(".photo").addEventListener("click",()=>openPreview(p.image));
    
    // input name
    div.querySelector('input[type="text"]').addEventListener("change", e=>updateName(p.id,e.target.value));
    
    // input URL
    div.querySelector('input[type="text"]:nth-of-type(2)').addEventListener("change", e=>updateImage(p.id,e.target.value));
    
    // upload image
    //div.querySelector('input[type="file"]').addEventListener("change", e=>uploadImage(p.id,e.target.files[0]));
    
    // + и - для размеров
    div.querySelectorAll(".plus").forEach(btn=>{
      btn.addEventListener("click",()=>updateSize(p.id, btn.dataset.size, 1));
    });
    div.querySelectorAll(".minus").forEach(btn=>{
      btn.addEventListener("click",()=>updateSize(p.id, btn.dataset.size, -1));
    });

    // удалить товар
    div.querySelector(".remove").addEventListener("click",()=>removeProduct(p.id));

    // drag & drop
    div.addEventListener("dragstart", e=>handleDragStart(e,index));
    div.addEventListener("dragend", handleDragEnd);
    div.addEventListener("dragover", handleDragOver);
    div.addEventListener("drop", e=>handleDrop(e,index));

    container.appendChild(div);
  });

  const totals = calcTotals();
  document.getElementById("totals").textContent=`Итого по размерам: S ${totals.S}, M ${totals.M}, L ${totals.L}. Общий остаток: ${totals.all}`;
}


// ---------- Event listeners ----------
document.getElementById("btnAdd").addEventListener("click", addProduct);
document.getElementById("btnReset").addEventListener("click", resetAll);
document.getElementById("btnExport").addEventListener("click", exportCSV);
document.getElementById("csvFile").addEventListener("change", e => importCSV(e.target.files[0]));

// ---------- Initial load ----------
loadFromSupabase();
</script>
</body>
</html>
